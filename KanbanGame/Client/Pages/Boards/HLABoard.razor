@page "/HighLevelAnalysisboard"
@inject IBoardService BoardService
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

<div class="center">
    <h3>High Level Analysis Team</h3>
</div>
<div class="center">
    @* <button disabled="@IsForceUpdateDisabled" class="btn btn-outline-warning" @onclick="(() => SimulateBoard())">
            Force Update <i class="oi oi-sun"></i>
    </button> *@
    <button class="btn btn-outline-warning" @onclick="(() => SimulateBoard())">
            Force Update <i class="oi oi-sun"></i>
    </button>

    <input type="radio" class="btn-check" name="options-outlined" id="danger-outlined" checked="@IsReadySelected">
    <label class="btn btn-outline-danger" for="danger-outlined" @onclick="(() => StateNotReady())">Not Ready</label>

    <input type="radio" class="btn-check" name="options-outlined" id="success-outlined" checked="@IsNotReadySelected" onchange="@(() => SetReady())">
    <label class="btn btn-outline-success" for="success-outlined" @onclick="(() => StateReady())">Ready</label>

    <div style="margin:10px;font-size: large;">Users ready: @readyUserCount / @connectedUserCount</div>

</div>
<div class="center">
<SfKanban @ref="kanbanBoard" TValue="Card" KeyField="Column" DataSource="BoardService.Cards" Width="1800px">
    <KanbanColumns>
        <KanbanColumn HeaderText="" KeyField="@(new List<string>() {"None"})" TransitionColumns="@(new List<string>() {"Backlog"})" AllowAdding="true"></KanbanColumn>
        <KanbanColumn HeaderText="" KeyField="@(new List<string>() {"Backlog"})" TransitionColumns="@(new List<string>() {"Doing1", "None"})"></KanbanColumn>
        <KanbanColumn HeaderText="Doing1" MaxCount="@BoardService.ColumnMaxCount["Doing1"]" KeyField="@(new List<string>() {"Doing1"})" TransitionColumns="@(new List<string>() {"Backlog", "Doing2"})"></KanbanColumn>
        <KanbanColumn HeaderText="Doing2" MaxCount="@BoardService.ColumnMaxCount["Doing2"]" KeyField="@(new List<string>() {"Doing2"})" TransitionColumns="@(new List<string>() {"Doing1"})"></KanbanColumn>
        <KanbanColumn HeaderText="" KeyField="@(new List<string>() {"ReadyForDevelopment"})" TransitionColumns="@(new List<string>() {"ReadyForDevelopment"})"></KanbanColumn>
    </KanbanColumns>
    <KanbanStackedHeaders>
        <KanbanStackedHeader Text="Feature Pool" KeyFields="@(new List<string>() {"None"})"></KanbanStackedHeader>
        <KanbanStackedHeader Text="Backlog" KeyFields="@(new List<string>() {"Backlog"})"></KanbanStackedHeader>
        <KanbanStackedHeader Text="Doing" KeyFields="@(new List<string>() {"Doing1", "Doing2"})"></KanbanStackedHeader>
        <KanbanStackedHeader Text="ReadyForDevelopment" KeyFields="@(new List<string>() {"ReadyForDevelopment"})"></KanbanStackedHeader>
    </KanbanStackedHeaders>
    <KanbanSortSettings SortBy="SortOrderBy.Index" Field="RankId"></KanbanSortSettings>
    <KanbanEvents TValue="Card" DragStart="@DragStartHandler" DragStop="@DragStopHandler"></KanbanEvents>
    <KanbanCardSettings HeaderField="Id">
        <Template>
        @{
            Card card = (Card)context;

            if (card.Employee is not null)
            {
                Employee employee = card.Employee;

                <div class="employee-card">
                    <div class="employee-h">@employee.Name</div>
                    <div class="employee-a"><img src=@(employee.AvatarPath == null ? "Avatars/Default.png" : employee.AvatarPath) style="width:48px" alt="logo" /></div>
                    <div class="employee-d">
                        <div>Card Id: @card.Id</div>
                        <div>Id: @employee.Id</div>
                        <div>Seniority: @employee.Seniority.ToString()</div>
                        <div>Status: @employee.Status</div>
                        <div>Role: @employee.CurrentRole</div>
                        <div>Column: @employee.SF_Column</div>
                        <div>RankId: @card.RankId</div>
                    </div>
                </div>
            }
            else if (card.Feature is not null)
            {
                Feature feature = card.Feature;
                if (feature.Status == Feature.FeatureStatus.ReadyForDevelopment)
                {
                    <div class="task-card">
                        <div class="task-h">
                            <div>@feature.Title</div>
                        </div>
                        <div class="task-d">
                            <div>Card Id: @card.Id</div>
                            <div>Id: @feature.Id</div>
                            <div>Desc: @feature.Description</div>
                            <div>Tasks:</div>
                            @{
                                foreach (var t in feature.KanbanTasks)
                                {
                                    <li>@t.Title - @t.Type</li>
                                }
                            }
                            <b>@($"Est. $: {feature.EstimatedMinEarnings}K-{feature.EstimatedMaxEarnings}K")</b>
                        </div>
                        <div class="task-f">
                            RankId: @card.RankId
                            <button class="btn btn-primary" style="float:right;"
                                @onclick="(() => SendFeatureTasksToTeams(feature))">
                                <i class="oi oi-arrow-circle-right"></i>
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="task-card">
                        <div   class="task-h">@feature.Title</div>
                        <div class="task-d">
                            <div>Card Id: @card.Id</div>
                            <div>Id: @feature.Id</div>
                            <div>Desc: @feature.Description</div>
                            <div>Ass. Id: @(feature.Assignee is null ? "-" : feature.Assignee.Id)</div>
                            <div>Assignee.: @(feature.Assignee == null ? "-" : feature.Assignee.Name)</div>
                        </div>
                        <div class="task-f">RankId: @card.RankId <img src=@(feature.Assignee == null ? "Avatars/Default.png" : feature.Assignee.AvatarPath) style="width:32px; float:right;" alt="logo" /></div>
                    </div>
                }
            }
        }
        </Template>
    </KanbanCardSettings>
</SfKanban>
</div>
@code {
    private int BoardId = (int)Team.TeamName.HighLevelAnalysis;
    int EditionCode = 1;
    public SfKanban<Card> kanbanBoard;
    protected bool IsForceUpdateDisabled = true;
    private bool IsReadySelected = true;
    private bool IsNotReadySelected = false;
    private HubConnection? hubConnection;
    private int connectedUserCount = 0;
    private int readyUserCount = 0;
    protected override async Task OnInitializedAsync()
    {
        await BoardService.GetCardsByTeamId(BoardId);
        await Connect();
    }

    private async Task Connect()
    {
        hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri("/BoardHub"))
                .Build();

        await hubConnection.StartAsync();

        hubConnection.On<int>("BoardUpdated", async (_) =>
                {
                    await BoardService.GetCardsByTeamId(BoardId);
                    StateHasChanged();
                });
        hubConnection.On<int>("StateReady", async (numberOfReadyClients) =>
                {
                    readyUserCount = numberOfReadyClients;
                    IsForceUpdateDisabled = readyUserCount == connectedUserCount ? false : true;
                    StateHasChanged();
                });
        hubConnection.On<int>("StateNotReady", async (numberOfReadyClients) =>
                {
                    readyUserCount = numberOfReadyClients;
                    IsForceUpdateDisabled = readyUserCount == connectedUserCount ? false : true;
                    StateHasChanged();
                });
        hubConnection.On<int>("ClearReadyUsers", async (numberOfReadyClients) =>
                {
                    readyUserCount = numberOfReadyClients;
                    ResetReadiness();
                    IsForceUpdateDisabled = readyUserCount == connectedUserCount ? false : true;
                    StateHasChanged();
                });
        hubConnection.On<int>("UserCount", async (numberOfConnectedClients) =>
                {
                    connectedUserCount = numberOfConnectedClients;
                    IsForceUpdateDisabled = readyUserCount == connectedUserCount ? false : true;
                    StateHasChanged();
                });
    }

    private string? columnBeforeDrag;
    private string? columnAfterDrag;
    private string[] featureForbiddenSwap = { "Doing1", "Doing2" };
    private string[] employeeForbidenSwap = { "Backlog" };

    async Task DragStartHandler(DragEventArgs<Card> args)
    {
        columnBeforeDrag = args.Data[0].Column;
    }

    async Task DragStopHandler(DragEventArgs<Card> args)
    {

        Card draggedCard = args.Data[0];
        columnAfterDrag = draggedCard.Column;

        if (draggedCard.Feature is not null)

        {
            if (columnBeforeDrag != columnAfterDrag && (featureForbiddenSwap.Contains(columnBeforeDrag) && featureForbiddenSwap.Contains(columnAfterDrag)))
            {
                args.Cancel = true;
            }
            else
            {
                await BoardService.UpdateCardLocal(draggedCard.Id, draggedCard);
                await BoardService.UpdateColumn(columnBeforeDrag);
                if (columnBeforeDrag != columnAfterDrag)
                {
                    await BoardService.UpdateColumn(columnAfterDrag);
                }
                if (hubConnection is not null)
                {
                    await hubConnection.SendAsync("UpdateBoard", 0);
                }
            }
        }
        else if (draggedCard.Employee is not null)
        {
            if (employeeForbidenSwap.Contains(draggedCard.Column))
            {
                args.Cancel = true;
            }
            else
            {
                await BoardService.UpdateCardLocal(draggedCard.Id, draggedCard);
                await BoardService.UpdateColumn(columnBeforeDrag);
                await BoardService.UpdateColumn(columnAfterDrag);

                if (hubConnection is not null)
                {
                    await hubConnection.SendAsync("UpdateBoard", 0);
                }
            }
        }
    }

    async Task SimulateBoard()
    {
        await BoardService.SimulateBoard();
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("UpdateBoard", 0);
            await hubConnection.SendAsync("ClearReadyUsers", 0);
        }
    }
    private void SetReady()
    {
        IsReadySelected = false;
        IsNotReadySelected = true;
    }
    private void ResetReadiness()
    {
        IsReadySelected = true;
        IsNotReadySelected = false;
    }
    async Task StateReady()
    {
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("StateReady", 0);
        }
    }
    async Task StateNotReady()
    {
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("StateNotReady", 0);
        }
    }
    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    async Task SendFeatureTasksToTeams(Feature feature)
    {
        await BoardService.SendFeatureTasksToTeams(feature);
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("UpdateBoard", 0);
        }
    }
}